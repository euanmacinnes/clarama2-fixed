<div class="modal fade" tabindex="-1" id="addfieldModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Content (Fields or Tasks)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select Content</p>
                <select id="add_content"
                        name="add_content"
                        size="10"
                        class="form-control">

                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary"
                        onclick="add_selected_content('/content/element/{{ file_url }}')">Add
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function isDict(v) {
        return typeof v === 'object' && v !== null && !(v instanceof Array) && !(v instanceof Date);
    }

    $(document).ready(() => {
        $('#addfieldModal').on('shown.bs.modal', function () {
            filters = $(".gridaddcontent").attr('filters');
            path = ($CLARAMA_ROOT + '/content/json/{{ file_url | path }}?subfolders=True&extensions=' + filters);

            fetch(path)
                .then((response) => response.json())
                .then((json_files) => {
                    items = json_files['results']['files'];
                    $('#add_content').empty();

                    jQuery.each(items, function () {
                        console.log(this);
                        $('#add_content').append($('<option>').val(this).text(this));
                    });

                });
        });
        console.log("GRID");
        console.log({{ grid_id }}elements);
        console.log({{ grid_json | safe }});
    });

    const {{ grid_id }}elements = {{ element_json | safe }};

    let {{ grid_id }}subOptions = {
        cellHeight: 55, // should be 50 - top/bottom
        acceptWidgets: true, // will accept .grid-stack-item by default
        margin: 2,
        sizeToContent: true,
        subGridDynamic: false, // make it recursive for all future sub-grids
    };

    let {{ grid_id }}options = { // main grid options
        cellHeight: 55,
        margin: 2,
        float: true,
        minRow: 1, // don't collapse when empty
        acceptWidgets: true,
        subGridOpts: {{ grid_id }}subOptions,
        removable: '.trash',
        draggable: {cancel: '.no-drag'},
        subGridDynamic: false, // v7 api to create sub-grids on the fly
        children: {{ grid_json | safe }}
    };

    // document.querySelector('#saved').value = JSON.stringify(options);
    let {{ grid_id }}grid = GridStack.addGrid(document.querySelector('#containment-wrapper'), {{ grid_id }}options);

    function addNested() {
        {{ grid_id }}grid.addWidget({
            x: 0, y: 20, w: 4, h: 4,
            cellHeight: 75,
            margin: 2,
            minRow: 1, // don't collapse when empty
            acceptWidgets: true,
            removable: '.trash',
            subGridOpts: {
                children: [],
                ...{{ grid_id }}subOptions
            }
        });
    }

    function addContent(element, data, html) {
        if (isDict({{ grid_id }}elements)) {
            {{ grid_id }}elements[element] = new_element_data;
        } else {
            var elem = {};
            elem[element] = new_element_data;
            {{ grid_id }}elements = elem;
        }
        ;

        {{ grid_id }}elements[element] = data;

        {{ grid_id }}grid.addWidget({
            x: 0,
            y: 0,
            w: 4,
            h: 1,
            id: element,
            content: html,
            cellHeight: 65,
            margin: 5,
            minRow: 1, // don't collapse when empty
            acceptWidgets: true,
            removable: '.trash'
        })

        $('.clarama-embedded').load();
    }


    function saveGrid() {
        savedgrid = {{ grid_id }}grid.save(false, true);

        serializedData = {
            'grid': savedgrid,
            'elements': {{ grid_id }}elements
        };

        return serializedData;
    }

    function add_selected_content(element_render_url) {
        selected_val = "./" + $("#add_content").val();
        console.log("adding " + selected_val);

        if (selected_val == null) {
            flash("No file selected!")
        } else {
            // Find a unique element id
            var element_id = 0;
            var element_found = false;
            do {
                element = "element_" + element_id;

                if (element in {{ grid_id }}elements)
                    element_id = element_id + 1;
                else
                    element_found = true;
            }
            while (!element_found);

            console.log("element " + element);

            // Now add the element

            new_element_data = {"url": selected_val}

            slate_data = saveGrid();

            if (isDict(slate_data['elements'])) {
                slate_data['elements'][element] = new_element_data;
            } else {
                var elem = {};
                elem[element] = new_element_data;
                slate_data['elements'] = elem;
            }
            ;
            console.log(slate_data)

            $.ajax({
                type: 'POST',
                url: element_render_url + "?element=" + element,
                datatype: "html",
                contentType: 'application/json',
                data: JSON.stringify(slate_data),
                success: function (data) {
                    if (data['data'] == 'ok') {
                        addContent(element, new_element_data, data['results']);
                    } else {
                        console.log('Submission was successful.');
                        console.log(data);
                        flash("Couldn't save content: " + data['error']);
                    }
                },
                error: function (data) {
                    console.log('An error occurred.');
                    console.log(data);
                    flash("Couldn't render element content, access denied", "danger");
                }
            })
        }
    };

    function save(url) {
        slate_data = saveGrid();
        $.ajax({
            type: 'POST',
            url: url,
            datatype: "html",
            contentType: 'application/json',
            data: JSON.stringify(slate_data),
            success: function (data) {
                if (data['data'] == 'ok') {
                    console.log('Submission was successful.');
                    console.log(data);
                    flash("Saved!");
                } else {
                    console.log('Submission was successful.');
                    console.log(data);
                    flash("Couldn't save content: " + data['error']);
                }
            },
            error: function (data) {
                console.log('An error occurred.');
                console.log(data);
                flash("Couldn't save content, access denied", "danger");
            }
        })
    }

    function link_elements(target, linked) {
        var value = $("#" + target + "_" + linked).is(':checked');
        // flash("linking " + target + " to " + linked + " with " + value);

        if (linked in {{ grid_id }}elements) {

            if (target in {{ grid_id }}elements) {
                var element = {{ grid_id }}elements[target];

                if (!(element.hasOwnProperty("links"))) {
                    element['links'] = []
                }


                if (value) if (!(element['links'].includes(linked))) element['links'].push(linked);
                if (!(value))
                    if (element['links'].includes(linked)) {
                        element['links'].splice(element['links'].indexOf(linked), 1);
                    }

                flash("linking " + target + " to [" + element['links'] + "]");
            }
        }
    };
</script>
